<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<title>结算中心</title>
		<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
		<style>
			#bt{
				background:#4b6cb7;
			}
			
			#c{
				background:#bdc3c7;
			}
			
			#body{
				background:#f5f5f5;
			}
			
			#ctx1{
				background:#ffffff;
			}
			
		</style>
	</head>
	<body>
		<div id="body">
			<div id="bt"><!--1-->
			
			<div class="row">
				<h3 class="col-xs-10">结算中心</h3>
				<p class="row col-xs-2" style="padding-top: 15px;">
					<button class="btn btn-success" onclick="queryJieSuan()" style="width: 50%;margin-right: 10px;">查询</button>
					<button class="btn btn-default">关闭</button>
				</p>
			</div>
			<div style="padding: 0 15px;">
				<p style="height: 30px;border-bottom: 1px solid blue;"></p>
			</div>
			
			</div><!--1-->
			<div class="row" style="padding: 0 15px;">
				<div class="col-xs-11">
					<label>开单日期</label><input type="date" name="starttime" style="vertical-align: middle ; width:154px; height:33px;"/>至<input type="date" name="endtime" style="vertical-align: middle ; width:154px; height:33px;"/>&nbsp;&nbsp;&nbsp;
					<label style="margin-left: 69px;">销售单号</label><input type="text" name="wxdanno" style="vertical-align: middle ; width:154px; height:33px;"/>&nbsp;&nbsp;&nbsp;
					<label>结算状态</label>
					<select style="vertical-align: middle ; width:154px; height:33px;" name="jiesuanstatu">
						<option value="">请选择</option>
						<option value="已结算">已结算</option>
						<option value="未结算">未结算</option>
					</select>&nbsp;&nbsp;&nbsp;
					<label>车牌号</label><input type="text" name="chepai" style="vertical-align: middle ; width:154px; height:33px;"/>&nbsp;&nbsp;&nbsp;
					<br />
					<label>客户名称</label>
					<input type="text" name="kehuname" style="vertical-align: middle ; width:154px; height:33px;">&nbsp;&nbsp;&nbsp;
					<label>服务顾问</label>
					<select name="guwen" style="vertical-align: middle ; width:154px; height:33px;">
						<option value="">请选择</option>
						<option value="李">李</option>
						<option value="王">王</option>
						<option value="刘">刘</option>
					</select>&nbsp;&nbsp;&nbsp;
					<label>业务类型</label>
					<select name="yewutype" style="vertical-align: middle ; width:154px; height:33px;">
						<option value="">请选择</option>
					</select>&nbsp;&nbsp;&nbsp;
					<label>单据状态</label>
					<select name="danjustatu" style="vertical-align: middle ; width:154px; height:33px;">
						<option value="">全部</option>
						<option value="已竣工">已完工</option>
						<option value="作业中">未完工</option>
					</select>&nbsp;&nbsp;&nbsp;
					<label>备注&nbsp;&nbsp;&nbsp;&nbsp;</label><input type="text" name="remark" style="vertical-align: middle ; width:154px; height:33px;"/>
				</div>
			</div>
			
			<p style="padding: 20px 0px 20px 25px;font-size: 18px;">
				<a href="javascript:void(0)" style="margin-right: 20px;" onclick="shouyin()"><span class="glyphicon glyphicon-th" aria-hidden="true"data-toggle="modal" data-target="#myModal3"></span>收银</a>
				<a href="javascript:void(0)" onclick="toWeiXiuDan()" style="margin-right: 20px;"><span class="glyphicon glyphicon-share" aria-hidden="true"></span>打开单据</a>
				<!-- <a href="javascript:void(0)" style="margin-right: 20px;">导出</a> -->
			</p>
			<div>
				<table id="ctx1" class="table table-hover table-bordered text-center ">
						<thead>
							<tr id="c">
								<th></th>
								<th class="text-center">单号</th>
								<th class="text-center">单据类型</th>
								<th class="text-center">结算方式</th>
								<th class="text-center">单据状态</th>
								<th class="text-center">结算时间</th>
								<th class="text-center">结算人</th>
								<th class="text-center">结算金额</th>
								<th class="text-center">业务类型</th>
								<th class="text-center">客户名称</th>
								<th class="text-center">车牌</th>
								<th class="text-center">车辆型号</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="item in alljiesuan" onclick="trclick(this)">
								<td><input type="radio" name="jiesuan" disabled="disabled"></td>
								<td class="text-center">{{item.wxdanno}}</td>
								<td class="text-center">{{item.wxdantype}}</td>
								<td class="text-center">{{item.jiesuantype}}</td>
								<td class="text-center">{{item.danjustatu}}</td>
								<td class="text-center">{{item.jiesuantime}}</td>
								<td class="text-center">{{item.bei2}}</td>
								<td class="text-center">{{item.jiesuanmoney}}</td>
								<td class="text-center">{{item.yewutype}}</td>
								<td class="text-center">{{item.kehuname}}</td>
								<td class="text-center">{{item.chepai}}</td>
								<td class="text-center">{{item.xinghao}}</td>
							</tr>
						</tbody>
				</table>
			</div>
			<!-- 模态框部分 -->
			<div class="modal" tabindex="-1" role="dialog" id="jiesuan">
			  	<div class="modal-dialog" role="document">
			    	<div class="modal-content">
			      		<div class="modal-header">
					        <button type="button" class="close" data-dismiss="modal" aria-label="close"><span aria-hidden="true">&times;</span></button>
					        <div class="row">
					        	<h3 class="modal-title col-xs-9">结算</h3>
					        </div>
			      		</div>
				      	<div class="modal-body row" style="font-size: 17px;">
				      		<p class="col-xs-12">会员姓名：{{jiesuanhuiyuan.huiyuanname}}<strong></strong></p>
				      		<p class="col-xs-6">会员余额：{{jiesuanhuiyuan.huiyuanmoney}}￥<span style="font-weight: 700;font-size:15px;color:green;"></span></p>
				      		<p class="col-xs-6">会员折扣：{{jiesuanhuiyuan.youhui}}折<span style="font-weight: 700;font-size:15px;color:red;"></span></p>
							<p class="col-xs-12" style="height: 25px;border-bottom:1px solid;"></p>
				      		<p class="col-xs-6" style="font-size:17px;font-weight: 700;">维修单号：{{jiesuandan}}</p>
				      		<p class="col-xs-6" style="font-size:17px;font-weight: 700;">维修车牌：{{jiesuanchepai}}</p>
				      		<p class="col-xs-6" style="font-size:17px;font-weight: 700;">单据金额：{{jiesuanzongjia}}</p>
				      		<p class="col-xs-6" style="font-size:17px;font-weight: 700;">&nbsp;</p>
				      		<div style="margin-left: 20px;margin-top: 20px;">
								<div class="input-group">
									<span class="input-group-addon">结算方式</span>
									<select id="jiesuantype" style="vertical-align: middle ; width:160px; height:33px;">
										<option>现金</option>
										<option>微信</option>
										<option id="hyoption" disabled="disabled">会员卡</option>
									</select>
								</div>
				      		</div>
				      		<button class="btn btn-default" style="margin-left: 20px;margin-top: 25px;" onclick="quedinjiesuan()">确定</button>
				      	</div>
			    	</div><!-- /.modal-content -->
			  	</div><!-- /.modal-dialog -->
			</div><!-- /.modal -->
		</div>
		
	</body>
	<script type="text/javascript" src="js/jquery-3.4.1.min .js" ></script>
	<script type="text/javascript" src="js/vue.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js" ></script>
	<script type="text/javascript" src="js/my.js"></script>
	<script type="text/javascript">
		var vm = new Vue({
			el:"#body",
			data(){
				return {
					alljiesuan:[],
					selectedwxdanno:"",
				    selectedchepai:"",
				    jiesuanhuiyuan:{},
				    jiesuandan:"",
				    jiesuanchepai:"",
				    jiesuanmoney:null,
				    jiesuanzongjia:0,
				}
			},
			methods:{
				
			}
		})
		var vmindex =null;
		//加载函数
		queryJieSuan();
		function queryJieSuan(){
			$.ajax({
				"url":data.ip +"jiesuanzhongxin/queryJieSuan",
				"data":"wxdanno="+$("[name='wxdanno']").val()+"&starttime="+$("[name='starttime']").val()+"&endtime="+$("[name='endtime']").val()
				+"&guwen="+$("[name='guwen']").val()+"&remark="+$("[name='remark']").val()+"&danjustatu="+$("[name='danjustatu']").val()+"&jiesuanstatu="+$("[name='jiesuanstatu']").val()
				+"&chepai="+$("[name='chepai']").val()+"&kehuname="+$("[name='kehuname']").val()+"&yewutype="+$("[name='yewutype']").val(),
				"type":"post",
				"success":function(result){
					vm.alljiesuan = result;
				},
				"error":function(){
					
				}
			})
		}
		function trclick(item){
			var index = $(item).index();
			if($("input[type=radio]")[index].checked){
				$("input[type=radio]")[index].checked =false;
				vmindex = null;
			}else{
				$("input[type=radio]")[index].checked =true;
				vmindex = index;
			}
				
		}
		//iframe跳转维修单
		function toWeiXiuDan(){
			var Myiframe=document.createElement("iframe");
			Myiframe.setAttribute("style","position:fixed;z-index:999;top:0px;left:0px;width:100%;height:100%;");
			Myiframe.src="lWeiXiuDan.html";
			Myiframe.id="weixiudan";
			var mybody=document.getElementById("body");
			if(vmindex==null){
				alert("未选中任何单据");
				Myiframe = null;
				mybody = null;
				return;
			}
			vm.selectedwxdanno = vm.alljiesuan[vmindex].wxdanno;
			vm.selectedchepai = vm.alljiesuan[vmindex].chepai;
			
			vmindex = null;
			mybody.append(Myiframe);
		}
		
		function load(){
			
		}
		
		function shouyin(){
			if(vmindex==null){
				alert("未选中任何单据");
				Myiframe = null;
				mybody = null;
				return;
			}
			if(vm.alljiesuan[vmindex].bei1=="未结算"){
				vm.selectedwxdanno = vm.alljiesuan[vmindex].wxdanno;
				vm.selectedchepai = vm.alljiesuan[vmindex].chepai;
				$.ajax({
					"url":data.ip +"huiyuan/jiesuanQuery",
					"data":"wxdanno="+vm.selectedwxdanno,
					"type":"post",
					"success":function(result){
						if(result != ""){
							vm.jiesuanhuiyuan = result;
							$("#jiesuantype")[0].selectedIndex = 2;
							$("#hyoption")[0].disabled=false;
						}else{
							vm.jiesuanhuiyuan = {huiyuanname:"此客户不是会员",huiyuanmoney:0,youhui:10,huiyuanno:null};
							$("#jiesuantype")[0].selectedIndex = 0;
							$("#hyoption")[0].disabled=true;
						}
					},
					"error":function(){
						alert("出错了");
					}
				})
				vm.jiesuandan = vm.selectedwxdanno;
				vm.jiesuanchepai = vm.selectedchepai;
				$.ajax({
					"url":data.ip +"jiesuanzhongxin/queryXiangMu",
					"data":"danno="+vm.selectedwxdanno,
					"type":"post",
					"success":function(result){
						for(var i = 0;i<result.length;i++){
							vm.jiesuanzongjia=vm.jiesuanzongjia + parseFloat(result[i].shoujiaan);
						}
					},
					"error":function(){
						alert("加载出错了！");
					}
				})
				$("#jiesuan").modal("show");
			}else{
				alert("此单已结算!");
			}
		}
		
		function quedinjiesuan(){
				if($("#jiesuantype").val()=="会员卡"){
					$.ajax({
						"url":data.ip +"huiyuan/jiesuanyanzheng",
						"data":"huiyuanno="+vm.jiesuanhuiyuan.huiyuanno+"&money="+parseFloat(vm.jiesuanzongjia)*(parseInt(vm.jiesuanhuiyuan.youhui)/10),
						"type":"post",
						"success":function(result){
							if(result == "1"){
								alert("会员已过期，请先延期！");
								return;
							}
							if(result == "2"){
								alert("会员余额不足，请及时充值！");
								return;
							}
							if(result == "3"){
								alert("会员余额不足，并且已过期！");
								return;
							}
							$.ajax({
								"url":data.ip +"jiesuanzhongxin/jiesuaninsert",
								"data":"money="+parseFloat(vm.jiesuanzongjia)*(parseInt(vm.jiesuanhuiyuan.youhui)/10)+"&wxdanno="+vm.jiesuandan+"&huiyuanno="+vm.jiesuanhuiyuan.huiyuanno+"&jiesuantype="+$("#jiesuantype").val(),
								"type":"post",
								"success":function(result){
									alert("结算成功！");
									queryJieSuan();
									$("#jiesuan").modal("hide");
								},
								"error":function(){
									alert("结算失败！");
									queryJieSuan();
									$("#jiesuan").modal("hide");
								}
							})
						},
						"error":function(){
							alert("出错了！");
						}
					})
				}else{
					$.ajax({
						"url":data.ip +"jiesuanzhongxin/jiesuaninsert",
						"data":"money="+parseFloat(vm.jiesuanzongjia)*(parseInt(vm.jiesuanhuiyuan.youhui)/10)+"&wxdanno="+vm.jiesuandan+"&huiyuanno="+vm.jiesuanhuiyuan.huiyuanno+"&jiesuantype="+$("#jiesuantype").val(),
						"type":"post",
						"success":function(result){
							alert("结算成功！");
							queryJieSuan();
							$("#jiesuan").modal("hide");
						},
						"error":function(){
							alert("结算失败！");
							queryJieSuan();
							$("#jiesuan").modal("hide");
						}
					})
				}
		}
	</script>
</html>
